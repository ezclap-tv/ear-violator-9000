<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge" http-equiv="X-UA-Compatible" />
    <title>Ear Violator 9000</title>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
  </head>
  <body>
    <script>
      async function async_send(ws, msg, then) {
        return new Promise((resolve, reject) => {
          let onmsg = (msg) => (ws.removeEventListener("message", onmsg), resolve(msg));
          let onerr = (err) => (ws.removeEventListener("error", onerr), reject(err));
          ws.addEventListener("message", onmsg);
          ws.addEventListener("error", onerr);
          ws.send(msg);
        });
      }

      class Store {
        #key;
        #data;
        constructor(key, initial) {
          this.#key = key;
          this.#data = JSON.parse(localStorage.getItem(key)) ?? initial;
        }

        set(data) {
          this.#data = data;
          localStorage.setItem(this.#key, JSON.stringify(data));
        }

        get() {
          return this.#data;
        }
      }

      const VIOLATORS = new Store("violators", ["moscowwbish", "compileraddict"]);
      const SOUNDS = {
        ok: "ok.mp3",
        a: "a.ogg",
        abayo: "abayo.ogg",
        ahmspigginit: "AHMSPIGGINIT.ogg",
        ahoy: "ahoy.ogg",
        ame_hates_minecraft: "ame_hates_minecraft.mp3",
        ame_minecraft: "ame_minecraft.mp3",
        ame_mining: "ame_mining.mp3",
        amogus: "amogus.ogg",
        anbribaboo: "anbribaboo.ogg",
        aquaa: "aquaa.ogg",
        aquaap: "aquaap.ogg",
        aquaquaquaaa: "aquaquaquaaa.ogg",
        away: "away.ogg",
        bananak: "bananak.ogg",
        baqua: "baqua.ogg",
        based: "based.ogg",
        baseddepartment: "baseddepartment.ogg",
        booba: "booba.ogg",
        botankek: "botankek.ogg",
        bubba: "bubba.ogg",
        bwahaha: "bwahaha.ogg",
        circus: "circus.ogg",
        cocomitai: "cocomitai.ogg",
        cringe: "cringe.ogg",
        dindin: "dindin.ogg",
        dododo: "dododo.ogg",
        f: "f.ogg",
        flower: "flower.ogg",
        frustrate: "frustrate.ogg",
        ganbare: "ganbare.mp3",
        ganbarushia: "ganbarushia.ogg",
        goodmorning: "goodmorning.ogg",
        guh: "guh.ogg",
        gwak: "gwak.ogg",
        haachama: "haachama.ogg",
        heheyeb: "heheyeb.ogg",
        help: "help.ogg",
        heyguys: "heyguys.ogg",
        heymoona: "heymoona.ogg",
        hi_honey_nene: "hi_honey_nene.mp3",
        hic: "hic.ogg",
        hirys: "hirys.ogg",
        horeesheeit: "horeesheeit.ogg",
        horny: "horny.ogg",
        icantbreathe: "icantbreathe.ogg",
        im_pomu: "im_Pomu.ogg",
        imdie: "imdie.ogg",
        impomu: "impomu.ogg",
        inainaina: "inainaina.ogg",
        inascared: "inascared.ogg",
        isee: "isee.ogg",
        itsmepekora: "itsmepekora.ogg",
        kek: "kek.ogg",
        kikiriki: "kikiriki.ogg",
        killme: "killme.ogg",
        killyou: "killyou.ogg",
        kneel: "kneel.ogg",
        konnui: "konnui.ogg",
        koroneunravel: "koroneunravel.ogg",
        kroni: "kroni.ogg",
        kuso: "kuso.ogg",
        loser: "loser.ogg",
        marinelaugh: "marinelaugh.ogg",
        matanene: "matanene.ogg",
        meds: "meds.ogg",
        mofumofu: "mofumofu.ogg",
        morinayeah: "morinayeah.ogg",
        mumeiflower: "mumeiflower.ogg",
        naaa: "naaa.ogg",
        nanora: "nanora.ogg",
        naruhodone: "naruhodone.ogg",
        ne: "ne.ogg",
        neehidoi: "neehidoi.ogg",
        nene: "nene.ogg",
        notsus: "notsus.ogg",
        nowaifu: "nowaifu.ogg",
        nyahello: "nyahello.ogg",
        ogey: "ogey.ogg",
        oh_my_gah_okayu: "oh_my_gah_okayu.ogg",
        oh_nyoo: "oh_nyoo.ogg",
        ohnojesas: "ohnojesas.ogg",
        ok: "ok.mp3",
        omegalol: "omegalol.ogg",
        pardun: "pardun.ogg",
        peace: "peace.ogg",
        peko: "peko.ogg",
        pekola_v3: "pekola_v3.mp3",
        pekolaughshort: "pekolaughshort.ogg",
        pekolol: "pekolol.ogg",
        pepeloni: "pepeloni.ogg",
        pogudansushort: "pogudansushort.ogg",
        poi: "poi.ogg",
        porukaoruka: "porukaoruka.ogg",
        presentforyou: "presentforyou.ogg",
        reps: "reps.ogg",
        rrats: "rrats.ogg",
        rratsim: "rratsim.ogg",
        rrreha: "rrreha.ogg",
        secretmoney: "secretmoney.ogg",
        shutup: "shutup.ogg",
        siren: "siren.ogg",
        slurp: "slurp.ogg",
        slurpp: "slurpp.ogg",
        sneed: "sneed.ogg",
        speggingit: "speggingit.ogg",
        stayhome: "stayhome.ogg",
        sus: "sus.ogg",
        tasukete: "tasukete.mp3",
        teme: "teme.ogg",
        tone: "tone.ogg",
        towababy: "towababy.ogg",
        true: "true.ogg",
        uoh: "uoh.ogg",
        uuuu: "uuuu.ogg",
        wah: "wah.ogg",
        wasnt_searching: "wasnt_searching.mp3",
        watamefactory: "watamefactory.ogg",
        watamewarukunai: "watamewarukunai.ogg",
        wearefaq: "wearefaq.ogg",
        why: "why.ogg",
        wtf: "wtf.ogg",
        yabe: "yabe.ogg",
        yay: "yay.ogg",
        yubi: "yubi.ogg",
        zomlol: "zomlol.ogg",
      };
      /** @type {Map<string, HTMLAudioElement} */
      const CACHE = new Map();

      const PREFIX = "!xd";
      const COMMANDS = {
        $add: {
          allows: (user) => user === "moscowwbish",
          handle(user, args) {
            const target = args.join().trim().toLowerCase();
            console.log(`${user} added ${target} as violator`);
            VIOLATORS.set([...new Set([...VIOLATORS.get(), target])]);
          },
        },
        $rm: {
          allows: (user) => user === "moscowwbish",
          handle(user, args) {
            const target = args.join().trim().toLowerCase();
            console.log(`${user} removed ${target} as violator`);
            VIOLATORS.set(VIOLATORS.get().filter((u) => u !== target));
          },
        },
        $play: {
          allows: (user) => VIOLATORS.get().includes(user),
          handle(user, args) {
            const sound = "sounds/" + SOUNDS[args.join()];
            if (!CACHE.has(sound)) CACHE.set(sound, new Audio(sound));
            console.log(`${user} played ${sound}`);
            CACHE.get(sound).play();
          },
        },
      };

      const RE = /:(.*)!.*PRIVMSG.*:(.*)[\r\n]*/g;
      function handle(message) {
        const [user, msg] = [...message.matchAll(RE)]?.[0]?.slice(1) ?? [];
        if (!user || !msg) return;

        const [prefix, cmd, ...args] = msg.split(" ");
        if (prefix !== PREFIX) return;
        if (!cmd.startsWith("$")) {
          if (!COMMANDS.$play.allows(user)) return;
          COMMANDS.$play.handle(user, [cmd].concat(args));
        } else {
          if (!COMMANDS[cmd].allows(user)) return;
          COMMANDS[cmd].handle(user, args);
        }
      }

      function connect() {
        return new Promise((resolve, reject) => {
          const url = `${window.location.protocol.startsWith("https") ? "wss" : "ws"}://irc-ws.chat.twitch.tv`;

          function retry(e) {
            if (e) console.error(e);
            console.warn("Failed to connect, retrying...");
            ws = new WebSocket(url);
            ws.onerror = retry;
            ws.onclose = retry;
            ws.onopen = onopen;
          }
          async function onopen() {
            await async_send(ws, "CAP REQ :twitch.tv/membership");
            let res = await async_send(ws, "NICK justinfan37982");
            if (res.data.startsWith(":tmi.twitch.tv 001")) {
              ws.send("JOIN #moscowwbish");
              ws.onerror = function () {};
              ws.onclose = function () {};
              ws.onopen = function () {};
              resolve(ws);
            } else {
              if (ws.readyState === WebSocket.OPEN) ws.close();
              reject(new Error("Failed to join"));
            }
          }

          let ws = new WebSocket(url);
          ws.onerror = retry;
          ws.onclose = retry;
          ws.onopen = onopen;
        });
      }

      (async () => {
        async function onclose() {
          console.log("Disconnected, reconnecting...");
          ws = await connect();
          ws.onclose = onclose;
          ws.onmessage = onmessage;
        }

        function onmessage({ data }) {
          if (data.includes("PING")) return ws.send("PONG :tmi.twitch.tv");
          handle(data);
        }

        let ws = await connect();
        ws.onclose = onclose;
        ws.onmessage = onmessage;

        console.log("Connected");
        console.log("prefix", PREFIX);
        console.log("commands", Object.keys(COMMANDS));
        console.log("violators", VIOLATORS.get());
        console.log("sounds", SOUNDS);
      })();
    </script>
  </body>
</html>
