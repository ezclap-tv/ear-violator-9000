<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge" http-equiv="X-UA-Compatible" />
    <title>Ear Violator 9000</title>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
  </head>
  <body>
    <script>
      async function async_send(ws, msg, then) {
        return new Promise((resolve, reject) => {
          let onmsg = (msg) => (ws.removeEventListener("message", onmsg), resolve(msg));
          let onerr = (err) => (ws.removeEventListener("error", onerr), reject(err));
          ws.addEventListener("message", onmsg);
          ws.addEventListener("error", onerr);
          ws.send(msg);
        });
      }

      class Store {
        #key;
        #data;
        constructor(key, initial) {
          this.#key = key;
          this.#data = JSON.parse(localStorage.getItem(key)) ?? initial;
        }

        set(data) {
          this.#data = data;
          localStorage.setItem(this.#key, JSON.stringify(data));
        }

        get() {
          return this.#data;
        }
      }

      const VIOLATORS = new Store("violators", ["moscowwbish", "compileraddict"]);
      const SOUNDS = {
        ok: "sounds/ok.mp3",
      };
      /** @type {Map<string, HTMLAudioElement} */
      const CACHE = new Map();

      const PREFIX = "!xd";
      const COMMANDS = {
        $add: {
          allows: (user) => user === "moscowwbish",
          handle(user, args) {
            const target = args.join().trim().toLowerCase();
            console.log(`${user} added ${target} as violator`);
            VIOLATORS.set([...new Set([...VIOLATORS.get(), target])]);
          },
        },
        $rm: {
          allows: (user) => user === "moscowwbish",
          handle(user, args) {
            const target = args.join().trim().toLowerCase();
            console.log(`${user} removed ${target} as violator`);
            VIOLATORS.set(VIOLATORS.get().filter((u) => u !== target));
          },
        },
        $play: {
          allows: (user) => VIOLATORS.get().includes(user),
          handle(user, args) {
            const sound = SOUNDS[args.join()];
            if (!CACHE.has(sound)) CACHE.set(sound, new Audio(sound));
            console.log(`${user} played ${sound}`);
            CACHE.get(sound).play();
          },
        },
      };

      const RE = /:(.*)!.*PRIVMSG.*:(.*)[\r\n]*/g;
      function handle(message) {
        const [user, msg] = [...message.matchAll(RE)]?.[0]?.slice(1) ?? [];
        if (!user || !msg) return;

        const [prefix, cmd, ...args] = msg.split(" ");
        if (!prefix || !cmd) return;
        if (prefix !== PREFIX) return;
        if (!COMMANDS[cmd].allows(user)) return;
        COMMANDS[cmd].handle(user, args);
      }

      function connect() {
        return new Promise((resolve, reject) => {
          const url = `${window.location.protocol.startsWith("https") ? "wss" : "ws"}://irc-ws.chat.twitch.tv`;

          function retry(e) {
            if (e) console.error(e);
            console.warn("Failed to connect, retrying...");
            ws = new WebSocket(url);
            ws.onerror = retry;
            ws.onclose = retry;
            ws.onopen = onopen;
          }
          async function onopen() {
            await async_send(ws, "CAP REQ :twitch.tv/membership");
            let res = await async_send(ws, "NICK justinfan37982");
            if (res.data.startsWith(":tmi.twitch.tv 001")) {
              ws.send("JOIN #moscowwbish");
              ws.onerror = function () {};
              ws.onclose = function () {};
              ws.onopen = function () {};
              resolve(ws);
            } else {
              if (ws.readyState === WebSocket.OPEN) ws.close();
              reject(new Error("Failed to join"));
            }
          }

          let ws = new WebSocket(url);
          ws.onerror = retry;
          ws.onclose = retry;
          ws.onopen = onopen;
        });
      }

      (async () => {
        async function onclose() {
          console.log("Disconnected, reconnecting...");
          ws = await connect();
          ws.onclose = onclose;
          ws.onmessage = onmessage;
        }

        function onmessage({ data }) {
          if (data.includes("PING")) return ws.send("PONG :tmi.twitch.tv");
          handle(data);
        }

        let ws = await connect();
        ws.onclose = onclose;
        ws.onmessage = onmessage;

        console.log("Connected");
        console.log("prefix", PREFIX);
        console.log("commands", Object.keys(COMMANDS));
        console.log("violators", VIOLATORS.get());
        console.log("sounds", SOUNDS);
      })();
    </script>
  </body>
</html>
