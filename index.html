<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge" http-equiv="X-UA-Compatible" />
    <title>Ear Violator 9000</title>
    <meta content="width=device-width, initial-scale=1" name="viewport" />

    <style>
      table {
        font-family: Arial, Helvetica, sans-serif;
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 10px;
        table-layout: fixed;
      }

      td,
      th {
        border: 1px solid #ddd;
        padding: 8px;
      }

      tr:nth-child(even) {
        background-color: #f2f2f2;
      }

      th {
        padding-top: 12px;
        padding-bottom: 12px;
        text-align: left;
        background-color: #04aa6d;
        color: white;
      }

      input {
        padding: 12px 16px;
        font-size: 16px;
      }

      button {
        font-family: monospace;
        background-color: #4caf50; /* Green */
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        cursor: pointer;
      }

      button:hover {
        background-color: #3e8e41;
      }
    </style>
  </head>
  <body>
    <div>
      <table>
        <thead>
          <tr>
            <th>Chief Violator (Stream)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <input
                id="chief-violator-input"
                type="text"
                onkeydown="updateChiefViolator(this)"
              />
              <button onclick="updateChiefViolator()">Update</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div>
      <table>
        <thead>
          <tr>
            <th>Command</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><b>!xd $add username</b></td>
            <td>Add `username` as a new violator</td>
          </tr>
          <tr>
            <td><b>!xd $rm username</b></td>
            <td>Remove `username` from the violators</td>
          </tr>
          <tr>
            <td><b>!xd name</b></td>
            <td>Play the sound `name` on stream</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div>
      <table id="sounds">
        <thead>
          <tr>
            <th>#</th>
            <th>Sound</th>
            <th>Command (click to copy)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <script>
      async function async_send(ws, msg, then) {
        return new Promise((resolve, reject) => {
          let onmsg = (msg) => (ws.removeEventListener("message", onmsg), resolve(msg));
          let onerr = (err) => (ws.removeEventListener("error", onerr), reject(err));
          ws.addEventListener("message", onmsg);
          ws.addEventListener("error", onerr);
          ws.send(msg);
        });
      }

      class Store {
        #key;
        #data;
        constructor(key, initial) {
          this.#key = key;
          this.#data = JSON.parse(localStorage.getItem(key)) ?? initial;
        }

        set(data) {
          this.#data = data;
          localStorage.setItem(this.#key, JSON.stringify(data));
        }

        get() {
          return this.#data;
        }
      }

      const CHIEF_VIOLATOR = new Store("chiefViolator", "moscowwbish");
      const VIOLATORS = new Store("violators", ["moscowwbish", "compileraddict"]);
      const SOUNDS = {
        ok: "ok.mp3",
        a: "a.ogg",
        abayo: "abayo.ogg",
        ahmspigginit: "AHMSPIGGINIT.ogg",
        ahoy: "ahoy.ogg",
        ame_hates_minecraft: "ame_hates_minecraft.mp3",
        ame_minecraft: "ame_minecraft.mp3",
        ame_mining: "ame_mining.mp3",
        amogus: "amogus.ogg",
        anbribaboo: "anbribaboo.ogg",
        aquaa: "aquaa.ogg",
        aquaap: "aquaap.ogg",
        aquaquaquaaa: "aquaquaquaaa.ogg",
        away: "away.ogg",
        bananak: "bananak.ogg",
        baqua: "baqua.ogg",
        based: "based.ogg",
        baseddepartment: "baseddepartment.ogg",
        booba: "booba.ogg",
        botankek: "botankek.ogg",
        bubba: "bubba.ogg",
        bwahaha: "bwahaha.ogg",
        circus: "circus.ogg",
        cocomitai: "cocomitai.ogg",
        cringe: "cringe.ogg",
        dindin: "dindin.ogg",
        dododo: "dododo.ogg",
        f: "f.ogg",
        flower: "flower.ogg",
        frustrate: "frustrate.ogg",
        ganbare: "ganbare.mp3",
        ganbarushia: "ganbarushia.ogg",
        goodmorning: "goodmorning.ogg",
        guh: "guh.ogg",
        gwak: "gwak.ogg",
        haachama: "haachama.ogg",
        heheyeb: "heheyeb.ogg",
        help: "help.ogg",
        heyguys: "heyguys.ogg",
        heymoona: "heymoona.ogg",
        hi_honey_nene: "hi_honey_nene.mp3",
        hic: "hic.ogg",
        hirys: "hirys.ogg",
        horeesheeit: "horeesheeit.ogg",
        horny: "horny.ogg",
        icantbreathe: "icantbreathe.ogg",
        im_pomu: "im_Pomu.ogg",
        imdie: "imdie.ogg",
        impomu: "impomu.ogg",
        inainaina: "inainaina.ogg",
        inascared: "inascared.ogg",
        isee: "isee.ogg",
        itsmepekora: "itsmepekora.ogg",
        kek: "kek.ogg",
        kikiriki: "kikiriki.ogg",
        killme: "killme.ogg",
        killyou: "killyou.ogg",
        kneel: "kneel.ogg",
        konnui: "konnui.ogg",
        koroneunravel: "koroneunravel.ogg",
        kroni: "kroni.ogg",
        kuso: "kuso.ogg",
        loser: "loser.ogg",
        marinelaugh: "marinelaugh.ogg",
        matanene: "matanene.ogg",
        meds: "meds.ogg",
        mofumofu: "mofumofu.ogg",
        morinayeah: "morinayeah.ogg",
        mumeiflower: "mumeiflower.ogg",
        naaa: "naaa.ogg",
        nanora: "nanora.ogg",
        naruhodone: "naruhodone.ogg",
        ne: "ne.ogg",
        neehidoi: "neehidoi.ogg",
        nene: "nene.ogg",
        notsus: "notsus.ogg",
        nowaifu: "nowaifu.ogg",
        nyahello: "nyahello.ogg",
        ogey: "ogey.ogg",
        oh_my_gah_okayu: "oh_my_gah_okayu.ogg",
        oh_nyoo: "oh_nyoo.ogg",
        ohnojesas: "ohnojesas.ogg",
        ok: "ok.mp3",
        omegalol: "omegalol.ogg",
        pardun: "pardun.ogg",
        peace: "peace.ogg",
        peko: "peko.ogg",
        pekola_v3: "pekola_v3.mp3",
        pekolaughshort: "pekolaughshort.ogg",
        pekolol: "pekolol.ogg",
        pepeloni: "pepeloni.ogg",
        pogudansushort: "pogudansushort.ogg",
        poi: "poi.ogg",
        porukaoruka: "porukaoruka.ogg",
        presentforyou: "presentforyou.ogg",
        reps: "reps.ogg",
        rrats: "rrats.ogg",
        rratsim: "rratsim.ogg",
        rrreha: "rrreha.ogg",
        secretmoney: "secretmoney.ogg",
        shutup: "shutup.ogg",
        siren: "siren.ogg",
        slurp: "slurp.ogg",
        slurpp: "slurpp.ogg",
        sneed: "sneed.ogg",
        speggingit: "speggingit.ogg",
        stayhome: "stayhome.ogg",
        sus: "sus.ogg",
        tasukete: "tasukete.mp3",
        teme: "teme.ogg",
        tone: "tone.ogg",
        towababy: "towababy.ogg",
        true: "true.ogg",
        uoh: "uoh.ogg",
        uuuu: "uuuu.ogg",
        wah: "wah.ogg",
        wasnt_searching: "wasnt_searching.mp3",
        watamefactory: "watamefactory.ogg",
        watamewarukunai: "watamewarukunai.ogg",
        wearefaq: "wearefaq.ogg",
        why: "why.ogg",
        wtf: "wtf.ogg",
        yabe: "yabe.ogg",
        yay: "yay.ogg",
        yubi: "yubi.ogg",
        zomlol: "zomlol.ogg",
      };

      (function generateSoundTable() {
        const violatorInput = document.getElementById("chief-violator-input");
        violatorInput.value = CHIEF_VIOLATOR.get();

        const tbody = document.getElementById("sounds").getElementsByTagName("tbody")[0];

        let sounds = Object.keys(SOUNDS);
        for (const i in sounds) {
          const sound = sounds[i];
          const row = tbody.insertRow();
          const numberCell = row.insertCell();
          numberCell.appendChild(document.createTextNode(i));

          const soundCell = row.insertCell();
          soundCell.appendChild(document.createTextNode(sound));

          const commandCell = row.insertCell();
          const copyButton = document.createElement("button");
          commandCell.appendChild(copyButton);

          copyButton.textContent = `!xd ${sound}`;
          copyButton.onclick = () => {
            navigator.clipboard.writeText(copyButton.textContent).then(
              function () {
                copyButton.textContent = "Copied!";
                setTimeout(() => {
                  copyButton.textContent = `!xd ${sound}`;
                }, 1000);
              },
              function (err) {
                console.error("Async: Could not copy text: ", err);
              }
            );
          };
        }
      })();
      function updateChiefViolator(element) {
        if (element && event && event.key != "Enter") {
          return;
        }

        const node = document.getElementById("chief-violator-input");
        console.log("Chief violator changed to ", node.value);
        CHIEF_VIOLATOR.set(node.value);
        window.location.reload();
      }

      /** @type {Map<string, HTMLAudioElement} */
      const CACHE = new Map();

      const PREFIX = "!xd";
      const COMMANDS = {
        $add: {
          allows: (user) => user === CHIEF_VIOLATOR.get(),
          handle(user, args) {
            const target = args.join().trim().toLowerCase();
            console.log(`${user} added ${target} as violator`);
            VIOLATORS.set([...new Set([...VIOLATORS.get(), target])]);
          },
        },
        $rm: {
          allows: (user) => user === CHIEF_VIOLATOR.get(),
          handle(user, args) {
            const target = args.join().trim().toLowerCase();
            console.log(`${user} removed ${target} as violator`);
            VIOLATORS.set(VIOLATORS.get().filter((u) => u !== target));
          },
        },
        $play: {
          allows: (user) => VIOLATORS.get().includes(user),
          handle(user, args) {
            const sound = "sounds/" + SOUNDS[args.join()];
            if (!CACHE.has(sound)) CACHE.set(sound, new Audio(sound));
            console.log(`${user} played ${sound}`);
            CACHE.get(sound).play();
          },
        },
      };

      const RE = /:(.*)!.*PRIVMSG.*:(.*)[\r\n]*/g;
      function handle(message) {
        const [user, msg] = [...message.matchAll(RE)]?.[0]?.slice(1) ?? [];
        if (!user || !msg) return;

        const [prefix, cmd, ...args] = msg.split(" ");
        if (prefix !== PREFIX) return;
        if (!cmd.startsWith("$")) {
          if (!COMMANDS.$play.allows(user)) return;
          COMMANDS.$play.handle(user, [cmd].concat(args));
        } else {
          if (!COMMANDS[cmd].allows(user)) return;
          COMMANDS[cmd].handle(user, args);
        }
      }

      function connect() {
        return new Promise((resolve, reject) => {
          const url = `${
            window.location.protocol.startsWith("https") ? "wss" : "ws"
          }://irc-ws.chat.twitch.tv`;

          function retry(e) {
            if (e) console.error(e);
            console.warn("Failed to connect, retrying...");
            ws = new WebSocket(url);
            ws.onerror = retry;
            ws.onclose = retry;
            ws.onopen = onopen;
          }
          async function onopen() {
            await async_send(ws, "CAP REQ :twitch.tv/membership");
            let res = await async_send(ws, "NICK justinfan37982");
            if (res.data.startsWith(":tmi.twitch.tv 001")) {
              ws.send(`JOIN #${CHIEF_VIOLATOR.get()}`);
              ws.onerror = function () {};
              ws.onclose = function () {};
              ws.onopen = function () {};
              resolve(ws);
            } else {
              if (ws.readyState === WebSocket.OPEN) ws.close();
              reject(new Error("Failed to join"));
            }
          }

          let ws = new WebSocket(url);
          ws.onerror = retry;
          ws.onclose = retry;
          ws.onopen = onopen;
        });
      }

      (async () => {
        async function onclose() {
          console.log("Disconnected, reconnecting...");
          ws = await connect();
          ws.onclose = onclose;
          ws.onmessage = onmessage;
        }

        function onmessage({ data }) {
          if (data.includes("PING")) return ws.send("PONG :tmi.twitch.tv");
          handle(data);
        }

        let ws = await connect();
        ws.onclose = onclose;
        ws.onmessage = onmessage;

        console.log("Connected");
        console.log("prefix", PREFIX);
        console.log("commands", Object.keys(COMMANDS));
        console.log("chief", CHIEF_VIOLATOR.get());
        console.log("violators", VIOLATORS.get());
        console.log("sounds", SOUNDS);
      })();
    </script>
  </body>
</html>
